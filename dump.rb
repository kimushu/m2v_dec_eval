#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
#================================================================================
# dump.c dump.h 生成スクリプト
# $Id$
#================================================================================

DUMPS = %w[slice mb block dequant idct]

HEADER = <<EOD
//================================================================================
// m1v_dec_eval - データダンプ
// Do not edit this file. This file was generated by dump.rb.
//================================================================================

EOD

open("dump.c", "w") {|c|
	c.print(HEADER)
	c.print(<<EOD)
#include <string.h>
#include <stdarg.h>
#include "dump.h"

int dump_enable;
EOD
	DUMPS.each {|d|
		c.puts("FILE* dump_#{d};")
	}
	c.print(<<EOD)

const char* dump_init(const char* ref_dir)
{
	dump_enable = 0;
	if(!ref_dir) return NULL;

	char path[256];
	strcpy(path, ref_dir);
	char* fn = path + strlen(path);

EOD
	DUMPS.each {|d|
		c.print(<<EOD)
	strcpy(fn, "#{d}.txt");
	if(!(dump_#{d} = fopen(path, "w")))
		return "cannot open ref_*/#{d}.txt";
EOD
	}

	c.print(<<EOD)

	return NULL;
}

void dump_start()
{
	dump_enable = 1;
}

void dump_finish()
{
EOD
	DUMPS.each {|d|
		c.print(<<EOD)
	if(dump_#{d}) { fclose(dump_#{d}); dump_#{d} = NULL; }
EOD
	}
	c.print(<<EOD)
}

void dump(FILE* fp, const char* desc, const char* fmt, ...)
{
	if(!fp || !dump_enable) return;

	va_list args;
	va_start(args, fmt);

	char buf[256];
	vsprintf(buf, fmt, args);

	if(desc && *desc)
		fprintf(fp, "%-*s # %s\\n", 39, buf, desc);
	else
		fprintf(fp, "%s\\n", buf);

	va_end(args);
}

// END OF dump.c

EOD
}

open("dump.h", "w") {|h|
	h.print(HEADER)
	h.print(<<EOD)
#ifndef _DUMP_H_
#define _DUMP_H_

#include <stdio.h>

// exports
extern const char* dump_init(const char* ref_dir);
extern void dump_start();
extern void dump_finish();
extern void dump(FILE* fp, const char* desc, const char* fmt, ...);

// exported file pointers
EOD
	DUMPS.each {|d|
		h.puts("extern FILE* dump_#{d};")
	}
	h.print(<<EOD)

#endif	/* !_DUMP_H_ */

// END OF dump.h

EOD
}

